<html>
<head>
<title>test</title>
<script>
function connection(){
    var canvas =  document.getElementById("canvas");
    var ctx = canvas.getContext('2d');
    ctx.fillStyle = "black";

    var fpsIntervalId;
    var mesCount = 0;

    connection = new WebSocket('ws://127.0.0.1:8080');
    connection.onopen = function(e) {
        document.getElementById("connection").disabled= true;
        console.log("Connection established!");

        var startButton = document.getElementById("start");
        startButton.attributes.removeNamedItem("disabled");
        startButton.onclick = function(){
            connection.send(JSON.stringify({"app":"start","width":canvas.width,"height":canvas.height}));
            startButton.disabled= true;

            // FPS測定
            var preTime_fps=(new Date).getTime();
            var fpsElem = document.getElementById("FPS");
            fpsIntervalId = setInterval(function(){
                var now = (new Date).getTime();
                var div = now - preTime_fps;
                if(div >= 1000){
                    fpsElem.textContent = "FPS:" + parseInt(1000 / (div / mesCount ));
                    mesCount = 0;
                    preTime_fps = now;
                }
            },1000);

            window.addEventListener("keydown", function(ev){
                var sendData = {"app":"keydown", "key":ev.keyCode,};
                if(ev.repeat == false )connection.send(JSON.stringify(sendData));
            });
            window.addEventListener("keyup", function(ev){
                var sendData = {"app":"keyup", "key":ev.keyCode,};
                if(ev.repeat == false )connection.send(JSON.stringify(sendData));
            });
        }
    };

    connection.onerror = function(e){
        console.log(e);
    }

    var preTime=(new Date).getTime();

    connection.onmessage = function(e) {
        var now = (new Date).getTime();
        var div = now - preTime;
        // FPS制限
        if(div < 15){
            return;
        }
        preTime = now;

        // 描画
        var jsonData = JSON.parse(e.data);
        ctx.clearRect(0,0,canvas.width,canvas.height);
        Object.keys(jsonData).forEach(function(key){
            var objValue = jsonData[key];
            ctx.beginPath();
            ctx.arc(objValue.pos.x, objValue.pos.y, 10, 0, Math.PI*2, true);
            ctx.fill();
        })
        
        // FPS測定
        mesCount++;
    };

    connection.onclose = function(e) {
        console.log(e.data);
    };
}
window.onload=function(){
    var canvas = document.getElementById("canvas");
    canvas.width = canvas.parentElement.clientWidth;
}
</script>
</head>
<body>
<button id="connection" onclick="connection()">connection</button>
<button id="start" disabled >start</button>
<span id="FPS">FPS:</span>
<div style="border:1px solid black;width:600px;margin-top:1em">
    <canvas id="canvas" ></canvas>
</div>
</body>
</html>