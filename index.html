<html>
<head>
<title>test</title>
<script>

function connection(){
    var canvas =  document.getElementById("canvas");
    var ctx = canvas.getContext('2d');
    ctx.fillStyle = "black";

    var fpsIntervalId;
    var mesCount = 0;

    var connection;

    try{
        connection = new WebSocket('ws://127.0.0.1:8080');
    }catch(e){
        console.log(e);
        return;
    }

    connection.onopen = function(e) {
        document.getElementById("connection").disabled= true;
        console.log("Connection established!");

        connection.send(JSON.stringify({"app":"start","width":canvas.width,"height":canvas.height}));

        // FPS測定
        var preTime_fps=(new Date).getTime();
        var fpsElem = document.getElementById("FPS");
        fpsIntervalId = setInterval(function(){
            var now = (new Date).getTime();
            var div = now - preTime_fps;
            if(div >= 1000){
                fpsElem.textContent = "FPS:" + parseInt(1000 / (div / mesCount ));
                mesCount = 0;
                preTime_fps = now;
            }
        },1000);

        var keydownListener = function(ev){
            if(connection.readyState == 1){
                var sendData = {"app":"keydown", "key":ev.keyCode,};
                if(ev.repeat == false ){
                    connection.send(JSON.stringify(sendData));
                }
            }else if(connection.readyState == 2 || connection.readyState == 3){
                // closeing and closed
                window.removeEventListener("keydown", keydownListener);
            }
        }
        window.addEventListener("keydown", keydownListener);
        var keyupListener = function(ev){
            if(connection.readyState == 1){
                var sendData = {"app":"keyup", "key":ev.keyCode,};
                if(ev.repeat == false ){
                    connection.send(JSON.stringify(sendData));
                }
            }else if(connection.readyState == 2 || connection.readyState == 3){
                // closeing and closed
                window.removeEventListener("keyup", keyupListener);
            }
        }
        window.addEventListener("keyup", keyupListener);
    };

    connection.onerror = function(e){
        console.log(e);
        document.getElementById("connection").disabled= false;
    }

    var preTime=(new Date).getTime();

    connection.onmessage = function(e) {
        var now = (new Date).getTime();
        var div = now - preTime;
        // FPS制限
        if(div < 15){
            return;
        }
        preTime = now;

        // 描画
        var jsonData = JSON.parse(e.data);
        ctx.clearRect(0,0,canvas.width,canvas.height);
        Object.keys(jsonData).forEach(function(key){
            var objValue = jsonData[key];
            ctx.beginPath();
            switch(objValue["shape"]){
                case "normalBullet":
                    ctx.arc(objValue.pos.x, objValue.pos.y, 2, 0, Math.PI*2, true);
                    break;
                default:
                    ctx.arc(objValue.pos.x, objValue.pos.y, 10, 0, Math.PI*2, true);
            }
            ctx.fill();
        })
        
        // FPS測定
        mesCount++;
    };

    connection.onclose = function(e) {
        console.log(e.data);
        document.getElementById("connection").disabled= false;
    };
}
window.onload=function(){
    var canvas = document.getElementById("canvas");
    canvas.width = canvas.parentElement.clientWidth;
    canvas.height = canvas.parentElement.clientHeight;
}

</script>
</head>
<body>
<button id="connection" onclick="connection()">START</button>
<span id="FPS">FPS:</span>
<div style="border:1px solid black;height:400px;width:600px;margin-top:1em;margin:auto">
    <canvas id="canvas"></canvas>
</div>
</body>
</html>