<html>
<head>
<title>test</title>
<script>

function connection(){
    var canvas =  document.getElementById("canvas");
    var ctx = canvas.getContext('2d');
    ctx.fillStyle = "black";
    ctx.lineWidth = 1;

    var fpsIntervalId;
    var mesCount = 0;
    var drawCount = 0;

    var connection;
    var DrawObjects = {};

    try{
        connection = new WebSocket('ws://127.0.0.1:8080');
    }catch(e){
        console.log(e);
        return;
    }

    connection.onopen = function(e) {
        document.getElementById("connection").disabled= true;
        console.log("Connection established!");

        connection.send(JSON.stringify({"app":"start","width":canvas.width,"height":canvas.height}));

        // FPS測定
        var preTime_fps=(new Date).getTime();
        var fpsElem = document.getElementById("FPS");
        fpsIntervalId = setInterval(function(){
            var now = (new Date).getTime();
            var div = now - preTime_fps;
            if(div >= 1000){
                fpsElem.textContent = "Message/Sec:" + parseInt(1000 / (div / mesCount ))
                                        + ", Frame/Sec:" + parseInt(1000 / (div / drawCount ));
                mesCount = 0;
                drawCount = 0;
                preTime_fps = now;
            }
            if(connection.readyState == 2 || connection.readyState == 3){
                // closeing and closed
                clearInterval(fpsIntervalId);
            }
        },1000);


        // 描画
        canvasIntervalId = setInterval(function(){
            if(connection.readyState == 2 || connection.readyState == 3){
                // closeing and closed
                clearInterval(canvasIntervalId);
            }
            if(DrawObjects == null) return;

            ctx.clearRect(0,0,canvas.width,canvas.height);
            Object.keys(DrawObjects).forEach(function(key){
                var objValue = DrawObjects[key];
                switch(objValue["view"]){
                    case "PlayerBullet":
                        ctx.beginPath();
                        ctx.arc(objValue.pos.x, objValue.pos.y, 1, 0, Math.PI*2, true);
                        ctx.stroke();
                        ctx.closePath();
                        break;
                    case "Player":
                        var preFillStyle = ctx.fillStyle;
                        ctx.beginPath();
                        ctx.arc(objValue.pos.x, objValue.pos.y, 10, 0, Math.PI*2, true);
                        ctx.fill();
                        ctx.fillStyle = "red";
                        ctx.beginPath();
                        ctx.arc(objValue.pos.x, objValue.pos.y, 5, 0, Math.PI*2, true);
                        ctx.fill();
                        ctx.fillStyle = preFillStyle;
                        break;
                    case "Enemy":
                        ctx.beginPath();
                        ctx.arc(objValue.pos.x, objValue.pos.y, 10, 0, Math.PI*2, true);
                        ctx.fill();
                        break;
                    case "Polygon":
                        ctx.beginPath();
                        var firstPoint = objValue.polygon[0];
                        ctx.moveTo(firstPoint.x, firstPoint.y);
                        objValue.polygon.forEach(function(v){
                            ctx.lineTo(v.x, v.y);
                        })
                        ctx.lineTo(firstPoint.x, firstPoint.y);
                        ctx.stroke();
                        ctx.closePath();
                        break;
                    default:
                        ctx.beginPath();
                        ctx.arc(objValue.pos.x, objValue.pos.y, 10, 0, Math.PI*2, true);
                        ctx.fill();
                }
            })
            drawCount++;
        },16);
        // 1000(mSec) / 60(Frame) = 16.66...

        var keydownListener = function(ev){
            if(connection.readyState == 1){
                var sendData = {"app":"keydown", "key":ev.keyCode,};
                if(ev.repeat == false ){
                    connection.send(JSON.stringify(sendData));
                }
            }else if(connection.readyState == 2 || connection.readyState == 3){
                // closeing and closed
                window.removeEventListener("keydown", keydownListener);
            }
        }
        window.addEventListener("keydown", keydownListener);
        var keyupListener = function(ev){
            if(connection.readyState == 1){
                var sendData = {"app":"keyup", "key":ev.keyCode,};
                if(ev.repeat == false ){
                    connection.send(JSON.stringify(sendData));
                }
            }else if(connection.readyState == 2 || connection.readyState == 3){
                // closeing and closed
                window.removeEventListener("keyup", keyupListener);
            }
        }
        window.addEventListener("keyup", keyupListener);
    };

    connection.onerror = function(e){
        console.log(e);
        document.getElementById("connection").disabled= false;
    }

    connection.onmessage = function(e) {
        var jsonObj = JSON.parse(e.data);
        Object.assign(DrawObjects, jsonObj.update);
        jsonObj.remove.forEach(function(tag){
            delete DrawObjects[tag];
        })
        // FPS測定
        mesCount++;
    };

    connection.onclose = function(e) {
        console.log(e.data);
        document.getElementById("connection").disabled= false;
    };
}
window.onload=function(){
    var canvas = document.getElementById("canvas");
    canvas.width = canvas.parentElement.clientWidth;
    canvas.height = canvas.parentElement.clientHeight;
}

</script>
</head>
<body>
<button id="connection" onclick="connection()">START</button>
<span id="FPS">FPS:</span>
<div style="border:1px solid black;height:400px;width:600px;margin-top:1em;margin:auto">
    <canvas id="canvas"></canvas>
</div>
</body>
</html>